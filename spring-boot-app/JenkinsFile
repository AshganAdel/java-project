pipeline {
    agent any

    tools {
        // Install the Maven version configured as "M3" and add it to the path.
        maven "maven"
    }

    stages {
        stage('Checkout') {
            steps {
                git branch: 'master',
                    url: 'https://github.com/AshganAdel/java-project.git',
                    credentialsId: 'github-cred'
            }
        }
        stage('Build') {
            steps {
                dir('spring-boot-app'){
                  sh "mvn -Dmaven.test.failure.ignore=true clean package"
                  archiveArtifacts 'target/*.jar'
                }
            }
        }
        stage('SonarQube Scan') {
            steps {
                dir('spring-boot-app'){
                    withSonarQubeEnv('sonar') {
                    sh '''
                    mvn -B sonar:sonar \
                    -Dsonar.projectKey=java-app \
                    -Dsonar.projectName=java-app
                  '''
                  }
               }
            }
        }
        stage('docker-build'){
            steps {
                dir('spring-boot-app'){
                    sh "docker build -t ashganadel671/my-app:${BUILD_NUMBER} ."
                }
            }
        }
        stage('docker-push'){
            steps {
                script {
                    docker.withRegistry('https://index.docker.io/v1/', 'dockerhubcred') {
                        docker.image("ashganadel671/my-app:${BUILD_NUMBER}").push()
                    }
                }
            }
        }
        stage('Modify k8s files') {
            steps {
                dir('spring-boot-app-manifests'){
                    script {
                        sh "sed -i 's#ashganadel671/my-app:.*#ashganadel671/my-app:${BUILD_NUMBER}#' deployment.yml"
                    }
                }
                
            }
            
        }
        
        stage('Commit & Push Changes') {
            steps {
                withCredentials([usernamePassword(credentialsId: 'github-cred', usernameVariable: 'GIT_USER', passwordVariable: 'GIT_PASS')]) {
                    sh '''
                        git config user.email "adelashgan9@gmail.com"
                        git config user.name "AshganAdel"
                        git add *
                        git commit -m "Update image tag to ${BUILD_NUMBER}"
                        git remote set-url origin https://$GIT_USER:$GIT_PASS@github.com/AshganAdel/java-project.git
                        git push origin master
                    '''
                }
            }
        }


}
}
